<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">


  <title>Hammer.js</title>

  <script src="https://cdn.bootcss.com/html2canvas/0.5.0-beta4/html2canvas.js"></script>

<style>
</style>



</head>

<body >
<div style="position: relative" >
  <div id="avatarbb" ></div>

</div>
<div id="clcll" style="width: 100px;height: 100px;background-color: #0b97c4" onclick="clclc()"></div>
<img src="" id="render" alt="" style="width: 200px">
<button onclick="caijian()" style="position: fixed; left: 0px; top: 0px">click</button>
<button onclick="caijian2()" style="position: fixed; left: 220px; top: 0px">c22lick</button>



<!--<script src="hammer.js"></script>-->
<script src="https://cdn.bootcss.com/exif-js/2.3.0/exif.js"></script>
<script src="https://cdn.bootcss.com/hammer.js/2.0.8/hammer.js"></script>
<script>
  (function(global) {
    "use strict";
    var Mavatar = function(option) {
      this.el = document.querySelector(option.el);
      this.hd = typeof option.hd === 'boolean' ? option.hd : true;
      console.log(this.hd)
      this.backgroundColor = option.backgroundColor || '';
      this.dataUrl = null;
      this.file = null;
      this.width = option.width || '200px';
      this.height = option.height || '200px';
      this.imgWidth = null;
      this.imgHeight = null;
      this.orientation;
      this._init();


    };

    Mavatar.prototype = {
      _init: function(option) {
        var self = this;
        var width = this.width;
        var height = this.height;
        var el = this.el;
        var hd = this.hd;
        var MavatarContainer = document.createElement("div");
        var MavatarWraper = document.createElement("div");
        var canvasBox = document.createElement("div");
        var uploadImages = document.createElement("img");
        var renderImages = document.createElement("img");
        var uploadImagesInput = document.createElement("input");

        MavatarWraper.id = 'Mavatar-wrapper';
        MavatarWraper.style.width = width;
        MavatarWraper.style.height = height;
        MavatarWraper.style.backgroundColor = '#f0f0f0';
        MavatarWraper.style.position = 'relative';

        uploadImagesInput.type = 'file';
        uploadImagesInput.id = 'Mavatar-file';
        uploadImagesInput.style.width = width;
        uploadImagesInput.style.height = height;
        uploadImagesInput.style.position = 'absolute';
        uploadImagesInput.style.left = 0;
        uploadImagesInput.style.top = 0;
        uploadImagesInput.style.opacity = 0;

        canvasBox.id = 'Mavatar-canvasWrapper';
        canvasBox.style.width = width;
        canvasBox.style.height = height;
        canvasBox.style.display = 'none';
        canvasBox.style.Zindex = 2;
        canvasBox.style.overflow = 'hidden';

        renderImages.id = 'Mavatar-render';
        renderImages.style.display = 'none';
        renderImages.style.position = 'absolute';
        renderImages.style.left = 0;
        renderImages.style.top = 0;

        uploadImages.id = 'Mavatar-img';
        canvasBox.appendChild(uploadImages);
        MavatarWraper.appendChild(uploadImagesInput);
        MavatarWraper.appendChild(canvasBox);
        MavatarWraper.appendChild(renderImages);
        el.style.width = width;
        el.style.position = 'relative';
        el.appendChild(MavatarWraper);
        document.getElementById('Mavatar-file').addEventListener("change", function (files) {
          self.uploadImages(files)
        }, false);
        var reqAnimationFrame = (function () {
          return window[Hammer.prefixed(window, 'requestAnimationFrame')] || function (callback) {
            window.setTimeout(callback, 1000 / 60);
          };
        })();
        var dragEl = document.querySelector("#Mavatar-img");
        this.START_X = 0;
        this.START_Y = 0;
        var ticking = false;
        this.transform;
        var mc = new Hammer.Manager(dragEl);
        mc.add(new Hammer.Pan({ threshold: 0, pointers: 0 }));
        mc.add(new Hammer.Swipe()).recognizeWith(mc.get('pan'));
        mc.add(new Hammer.Rotate({ threshold: 0 })).recognizeWith(mc.get('pan'));
        mc.add(new Hammer.Pinch({ threshold: 0 })).recognizeWith([mc.get('pan'), mc.get('rotate')]);



        mc.on("panmove", onPan);


        mc.on("pinchmove", onPinch);
        // 触摸结束
        mc.on("panend",
          function(e) {
            self.START_X = self.transform.translate.x;
            self.START_Y = self.transform.translate.y;
          });
        mc.on("pinchend",
          function(e) {
            initScale = self.transform.scale;
          });

        function resetElement() {


          self.transform = {

            translate: { x: self.START_X, y: self.START_Y },

            scale: 1,

            angle: 0,

            rx: 0,

            ry: 0,

            rz: 0

          };

          requestElementUpdate();
        }
        function updateElementTransform() {
          var value = [
            'translate3d(' + self.transform.translate.x + 'px, ' + self.transform.translate.y + 'px, 0)',
            'scale(' + self.transform.scale + ', ' + self.transform.scale + ')',
            'rotate3d('+ self.transform.rx +','+ self.transform.ry +','+ self.transform.rz +','+  self.transform.angle + 'deg)'
          ];
          value = value.join(" ");
          dragEl.style.webkitTransform = value;
          dragEl.style.mozTransform = value;
          dragEl.style.transform = value;
          ticking = false;
        }
        function requestElementUpdate() {
          if(!ticking) {
            reqAnimationFrame(updateElementTransform);
            ticking = true;
          }
        }
        function onPan(ev) {
          self.transform.translate = {
            x: self.START_X + ev.deltaX,
            y: self.START_Y + ev.deltaY
          };
          requestElementUpdate();
        }
        var initScale = 1;
        function onPinch(ev) {
          if (ev.scale > 1) {
            self.transform.scale = initScale + ((ev.scale - 1)/2)
          } else {
            self.transform.scale = initScale - ((1 - ev.scale)/2)
          }
          requestElementUpdate();
        }

        resetElement();

      },
      clipfunction: function(getDataUrl) {
        var wrapperDom = document.getElementById('Mavatar-canvasWrapper')
        var width = this.width.replace(/[^0-9]/ig,"");
        var height = this.height.replace(/[^0-9]/ig,"");
        var type = "png";
        var scaleBy = this.hd ? 2 : 1; //缩放比例
        var canvas = document.createElement("canvas");
        // 获取元素相对于视窗的偏移量
        var rect = wrapperDom.getBoundingClientRect();
        console.log(rect);
        canvas.width = width * scaleBy;
        canvas.height = height * scaleBy;
        canvas.style.width = width + "px";
        canvas.style.height = height + "px";
        var context = canvas.getContext("2d");
        context.scale(scaleBy, scaleBy);
        // 设置context位置, 值为相对于视窗的偏移量的负值, 实现图片复位
        context.translate(-rect.left,-rect.top);
        console.log(width);
        console.log(canvas);
        document.getElementById('Mavatar-canvasWrapper').style.backgroundColor = this.backgroundColor ? this.backgroundColor : '';
        // var canvas = document.querySelector("canvas");
        var self = this;

        html2canvas(document.querySelector("#Mavatar-canvasWrapper"), {
          canvas:canvas,
          foreignObjectRendering: true,
          // taintTest: true,
          // logging: true,
          // profile: true,
          // useCORS: true,
          // height:260,
          // width:200,
          // scale:0.5,
        }).then(function(canvas) {
          var dataUrl = canvas.toDataURL("image/png");
          getDataUrl(dataUrl);
          self.dataUrl = dataUrl;
          document.getElementById('Mavatar-render').style.display = 'block';
          document.getElementById('Mavatar-render').src = dataUrl;
        });
      },
      getfileInfo: function () {
        var file = this.file;
        console.log(this.file)
        file.width = this.imgWidth;
        file.height = this.imgHeight;
        return file;
      },
      getformData: function (name, dataurl) {
        var timestamp = Date.parse(new Date());
        var filename = timestamp+'.png';
        var arr = dataurl.split(',');
        var mime = arr[0].match(/:(.*?);/)[1];
        var bstr = atob(arr[1]);
        var n = bstr.length;
        var u8arr = new Uint8Array(n);
        while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
        }
        var file = new File([u8arr], filename, {type: mime});
        var formData = new FormData();
        formData.append(name, file, timestamp+'.png');
        return formData;
      },
      getDataUrl: function (dataUrl) {
        return this.dataUrl;
      },
      resetImage: function(width, height) {
        var self = this;
        this.START_X = 0;
        this.START_Y = 0;
        this.transform = {
          translate: { x: 0, y: 0 },
          scale: 1,
          angle: 0,
          rx: 0,
          ry: 0,
          rz: 0
        };
        document.getElementById('Mavatar-render').style.display = 'none';
        document.getElementById('Mavatar-canvasWrapper').style.backgroundColor = '';
        var newUploadImagesInput = document.createElement("input");
        var oldUploadImagesInput = document.getElementById('Mavatar-file');
        newUploadImagesInput.type = 'file';
        newUploadImagesInput.id = 'Mavatar-file';
        newUploadImagesInput.style.width = this.width;
        newUploadImagesInput.style.height = this.height;
        newUploadImagesInput.style.position = 'absolute';
        newUploadImagesInput.style.left = 0;
        newUploadImagesInput.style.top = 0;
        newUploadImagesInput.style.opacity = 0;
        document.getElementById('Mavatar-wrapper').replaceChild(newUploadImagesInput,oldUploadImagesInput);
        document.getElementById('Mavatar-file').addEventListener("change", function (files) {
          self.uploadImages(files)
        }, false);
        document.getElementById('Mavatar-img').src = '';
        document.getElementById('Mavatar-canvasWrapper').style.display = 'none';
        document.getElementById('render').src = '';
        document.getElementById('render').style.display = 'none';
      },
      uploadImages: function(files) {
        var self = this;
        var _files = files || event.target.files;
        var _index = 0;
        var reader = new FileReader();
        this.file = files.target.files[_index];
        reader.readAsDataURL(files.target.files[_index]);
        reader.onload = function(event) {
          var image = new Image();
          image.src = this.result;
          document.body.appendChild(image);
          image.onload = function() {
            console.log(image.offsetWidth)
            self.imgWidth = image.offsetWidth;
            self.imgHeight = image.offsetHeight;
            EXIF.getData(image, function() { // 获取图像的数据
              EXIF.getAllTags(this); // 获取图像的全部数据，值以对象的方式返回
              var orientation = EXIF.getTag(this, "Orientation"); // 获取图像的拍摄方向
              var rotateCanvas = document.createElement("canvas"),
                rotateCtx = rotateCanvas.getContext("2d");
              // 针对图像方向进行处理
              switch (orientation) {
                case 1 :
                  rotateCanvas.width = image.offsetWidth;
                  rotateCanvas.height = image.offsetHeight;
                  rotateCtx.drawImage(image, 0, 0, image.offsetWidth, image.offsetHeight);
                  break;
                case 6 : // 顺时针 90 度
                  rotateCanvas.width = image.offsetHeight;
                  rotateCanvas.height = image.offsetWidth;
                  rotateCtx.translate(0, 0);
                  rotateCtx.rotate(90 * Math.PI / 180);
                  rotateCtx.drawImage(image, 0, -image.offsetHeight, image.offsetWidth, image.offsetHeight);
                  break;
                case 8 :
                  rotateCanvas.width = image.height;
                  rotateCanvas.height = image.width;
                  rotateCtx.translate(0, 0);
                  rotateCtx.rotate(-90 * Math.PI / 180);
                  rotateCtx.drawImage(image, -image.width, 0, image.width, image.height);
                  break;
                case 3 : // 180 度
                  rotateCanvas.width = image.width;
                  rotateCanvas.height = image.height;
                  rotateCtx.translate(0, 0);
                  rotateCtx.rotate(Math.PI);
                  rotateCtx.drawImage(image, -image.width, -image.height, image.width, image.height);
                  break;
                default :
                  rotateCanvas.width = image.width;
                  rotateCanvas.height = image.height;
                  rotateCtx.drawImage(image, 0, 0, image.width, image.height);

              }
              var rotateBase64 = rotateCanvas.toDataURL("image/png", 0.5);
              document.getElementById('Mavatar-img').src = rotateBase64;
              if (image.offsetHeight > image.offsetWidth) {
                      var width = self.height.replace(/[^0-9]/ig,"");
                      document.getElementById('Mavatar-img').style.height = self.height;
                      document.getElementById('Mavatar-img').style.width = 'auto';
                      var translatex = (width - (image.offsetWidth/(image.offsetHeight/width)))/2;
                      self.START_X = translatex;
                      document.getElementById('Mavatar-img').style.transform = 'translate('+translatex+'px,0px)';
              } else {
                var height = self.height.replace(/[^0-9]/ig,"");
                console.log(image.offsetHeight)
                var translatey = (height-(image.offsetHeight/(image.offsetWidth/height)))/2;
                console.log(translatey)
                document.getElementById('Mavatar-img').style.width = self.width;
                document.getElementById('Mavatar-img').style.height = 'auto';
                document.getElementById('Mavatar-img').style.transform = 'translate(0px,'+translatey+'px)';
                self.START_Y = translatey;
              }
              document.body.removeChild(image);
              document.getElementById('Mavatar-canvasWrapper').style.display = 'block';
            });
          }
        }
      }
    };
    if (typeof module !== 'undefined' && module.exports) module.exports = Mavatar;
    if (typeof define === 'function') define(function() { return Mavatar; });
    global.Mavatar = Mavatar;
  })(this);

  var avatarr = new Mavatar({el: '#avatarbb', hd: false})
  function caijian() {
    avatarr.clipfunction(function (data) {
      console.log(data);
    })


  }
  function caijian2() {
    var aa = avatarr.resetImage();
    var aa = avatarr.getfileInfo();
    var bb = avatarr.getDataUrl();
    console.log(aa);
    console.log(bb);
  }



</script>

</body>

</html>

